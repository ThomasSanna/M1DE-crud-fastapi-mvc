{% extends "base.html" %}

{% block title %}Modifier le produit - {{ produit.designation_p | e }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/list_produits.css">
<link rel="stylesheet" href="/static/css/produit_edit.css">
{% endblock %}

{% block content %}
<div class="produit-edit-container">
    <div class="produit-edit-header">
        <h1 class="produit-edit-title">Modifier le produit</h1>
        <p class="produit-id-info">ID: #{{ produit.id_p }}</p>
    </div>

    {% if error %}
        <div class="error-message">{{ error }}</div>
    {% endif %}

    {% if user %}
        <!-- Affichage des valeurs actuelles -->
        <div class="current-values">
            <h3>üìã Valeurs actuelles</h3>
            <div class="current-value-item">
                <span class="current-value-label">Type :</span>
                <span class="current-value-data">{{ produit.type_p | e }}</span>
            </div>
            <div class="current-value-item">
                <span class="current-value-label">D√©signation :</span>
                <span class="current-value-data">{{ produit.designation_p | e }}</span>
            </div>
            <div class="current-value-item">
                <span class="current-value-label">Prix HT :</span>
                <span class="current-value-data">{{ "%.2f"|format(produit.prix_ht) }} ‚Ç¨</span>
            </div>
            <div class="current-value-item">
                <span class="current-value-label">Stock :</span>
                <span class="current-value-data">{{ produit.stock_p }} unit√©{{ 's' if produit.stock_p != 1 else '' }}</span>
            </div>
            <div class="current-value-item">
                <span class="current-value-label">Date d'ajout :</span>
                <span class="current-value-data">
                    {% if produit.date_in %}
                        {{ produit.date_in.strftime('%d/%m/%Y') }}
                    {% else %}
                        Non renseign√©e
                    {% endif %}
                </span>
            </div>
        </div>

        <!-- Formulaire de modification -->
        <form action="/produits/{{ produit.id_p }}/edit" method="post" class="produit-form">
            <div class="form-group">
                <label for="type_p">Type de produit :</label>
                <input type="text" id="type_p" name="type_p" value="{{ produit.type_p | e }}" required>
                <div class="field-info">Cat√©gorie ou type du produit</div>
            </div>
            
            <div class="form-group">
                <label for="designation_p">D√©signation :</label>
                <input type="text" id="designation_p" name="designation_p" value="{{ produit.designation_p | e }}" required>
                <div class="field-info">Nom ou description du produit</div>
            </div>
            
            <div class="form-group">
                <label for="prix_ht">Prix HT (‚Ç¨) :</label>
                <input type="number" id="prix_ht" name="prix_ht" step="0.01" min="0" value="{{ produit.prix_ht }}" required>
                <div class="field-info">Prix hors taxes en euros</div>
            </div>
            
            <div class="form-group">
                <label for="date_in">Date d'ajout :</label>
                <input type="date" id="date_in" name="date_in" 
                       value="{% if produit.date_in %}{{ produit.date_in.strftime('%Y-%m-%d') }}{% endif %}" 
                       required>
                <div class="field-info">Date d'ajout du produit dans l'inventaire</div>
            </div>
            
            <div class="form-group">
                <label for="stock_p">Stock :</label>
                <input type="number" id="stock_p" name="stock_p" min="0" value="{{ produit.stock_p }}" required>
                <div class="field-info">Quantit√© disponible en stock</div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary">üíæ Enregistrer les modifications</button>
                <a href="/produits/{{ produit.id_p }}" class="btn-secondary">üëÅÔ∏è Voir le produit</a>
                <a href="/produits" class="btn-secondary">üìã Retour √† la liste</a>
                <button type="button" onclick="confirmDelete({{ produit.id_p }}, {{ produit.designation_p | tojson }})"
                        class="btn-danger">üóëÔ∏è Supprimer</button>
            </div>
        </form>
    {% else %}
        <div class="error-message">
            Vous devez √™tre connect√© pour modifier un produit.
            <a href="/login">Se connecter</a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Validation c√¥t√© client
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('.produit-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const prix = document.getElementById('prix_ht').value;
                const stock = document.getElementById('stock_p').value;
                
                if (parseFloat(prix) < 0) {
                    e.preventDefault();
                    alert('Le prix ne peut pas √™tre n√©gatif.');
                    return false;
                }
                
                if (parseInt(stock) < 0) {
                    e.preventDefault();
                    alert('Le stock ne peut pas √™tre n√©gatif.');
                    return false;
                }
            });
        }

        // Focus sur le premier champ
        const firstInput = document.getElementById('type_p');
        if (firstInput) {
            firstInput.focus();
        }

        // Confirmation des changements non sauvegard√©s
        let formChanged = false;
        const inputs = form.querySelectorAll('input');
        const originalValues = {};
        
        // Enregistrer les valeurs originales
        inputs.forEach(input => {
            originalValues[input.name] = input.value;
            input.addEventListener('input', () => {
                formChanged = true;
            });
        });

        // Avertissement si l'utilisateur quitte sans sauvegarder
        window.addEventListener('beforeunload', function(e) {
            if (formChanged) {
                const confirmationMessage = 'Vous avez des modifications non sauvegard√©es. √ätes-vous s√ªr de vouloir quitter ?';
                e.returnValue = confirmationMessage;
                return confirmationMessage;
            }
        });

        // Ne pas d√©clencher l'avertissement lors de la soumission du formulaire
        if (form) {
            form.addEventListener('submit', function() {
                formChanged = false;
            });
        }
    });

    function confirmDelete(productId, productName) {
        const confirmation = confirm(
            `‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\n` +
            `√ätes-vous absolument s√ªr de vouloir supprimer le produit :\n` +
            `"${productName}" (ID: #${productId}) ?\n\n` +
            `Cette action est IRR√âVERSIBLE et supprimera d√©finitivement toutes les donn√©es de ce produit.\n\n` +
            `Cliquez sur "OK" pour confirmer la suppression ou "Annuler" pour revenir √† l'√©dition.`
        );
        
        if (confirmation) {
            // D√©sactiver l'avertissement de changements non sauvegard√©s
            window.removeEventListener('beforeunload', arguments.callee);
            // Redirection vers la route de suppression
            window.location.href = `/produits/${productId}/delete`;
        }
    }
</script>
{% endblock %}
